<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CortexLog</title>
    <meta name="description" content="AI와 함께 생각을 엮어내는 공간, CortexLog입니다. 기술, 일상, AI에 대한 깊이 있는 인사이트를 탐험하세요.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    
    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&family=Pretendard:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #0B0B0B;
            --bg-content: #141414;
            --border-color: #2A2A2A;
            --text-primary: #F0F0F0;
            --text-secondary: #888888;
            --accent: #FFFFFF;
            --accent-hover: #1F1F1F;
            --font-heading: 'Plus Jakarta Sans', sans-serif;
            --font-body: 'Pretendard', sans-serif;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-size: 15px;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #app-background, #app-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; pointer-events: none;
        }
        #app-loader {
            z-index: 100; background-color: var(--bg-main);
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }

        .app-view { display: none; }
        .app-view.active { display: block; }

        .brand-logo {
            font-family: var(--font-heading); font-weight: 800; font-size: 1.25rem;
            color: var(--text-primary); letter-spacing: 0.5px;
        }

        .btn {
            padding: 0.4rem 0.9rem; font-size: 0.8rem; font-weight: 500; border-radius: 6px;
            transition: all 0.25s ease;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            border: 1px solid var(--border-color); background-color: transparent; color: var(--text-secondary);
            cursor: pointer;
        }
        .btn:hover {
            background-color: var(--accent-hover); color: var(--text-primary); transform: translateY(-2px);
            border-color: #444;
        }
        .btn-primary {
            border-color: var(--text-secondary); color: var(--text-primary);
        }
        .btn-primary:hover {
            background-color: var(--accent); color: var(--bg-main);
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; background-color: transparent !important; }

        .form-input, .form-textarea {
            font-size: 0.9rem; padding: 0.7rem 1rem; border: 1px solid var(--border-color);
            border-radius: 6px; width: 100%; background-color: var(--bg-main); color: var(--text-primary);
            transition: all 0.2s ease;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
        }
        
        .prose-custom { color: #b0b0b0; line-height: 1.8; font-size: 1rem; }
        .prose-custom h1, .prose-custom h2, .prose-custom h3 { color: var(--text-primary); font-family: var(--font-heading); font-weight: 700; margin-top: 1.8em; margin-bottom: 0.8em; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        .prose-custom h1 { font-size: 1.8rem; }
        .prose-custom h2 { font-size: 1.4rem; }
        .prose-custom h3 { font-size: 1.2rem; }
        .prose-custom a { color: var(--accent); text-decoration: none; font-weight: 500; border-bottom: 1px solid #555; transition: all 0.2s ease; }
        .prose-custom a:hover { border-bottom-color: var(--accent); }
        .prose-custom pre { background-color: #050505; padding: 1.2rem; border-radius: 6px; border: 1px solid var(--border-color); overflow-x: auto;}
        .prose-custom code { background-color: #222; padding: 0.2em 0.4em; border-radius: 3px; font-size: 0.9em; color: #eee; }
        .prose-custom blockquote { border-left: 2px solid var(--text-secondary); padding-left: 1.2rem; color: var(--text-secondary); font-style: italic; }
        .prose-custom img { border-radius: 8px; max-width: 100%; height: auto; }

        .ql-toolbar { border: 1px solid var(--border-color) !important; border-top-left-radius: 6px; border-top-right-radius: 6px; }
        .ql-container { border: 1px solid var(--border-color) !important; border-bottom-left-radius: 6px; border-bottom-right-radius: 6px; font-family: var(--font-body) !important;}
        .ql-editor { color: var(--text-primary); min-height: 300px; font-size: 0.95rem; }
        .ql-snow .ql-stroke { stroke: var(--text-secondary); }
        .ql-snow .ql-picker-label { color: var(--text-secondary) !important; }
    </style>
</head>
<body class="antialiased">
    <div id="app-loader">
        <div class="brand-logo text-2xl">CortexLog</div>
    </div>
    <canvas id="app-background"></canvas>

    <header id="main-nav-container" class="sticky top-0 z-40 w-full flex justify-center px-4 py-3"></header>
    
    <div id="app-container" class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <main id="main-content">
            <div id="view-library" class="app-view"></div>
            <div id="view-post" class="app-view"></div>
            <div id="view-dashboard" class="app-view"></div>
            <div id="view-writer" class="app-view"></div>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-3"></div>
    
    <script type="module">
        // --- SETUP & STATE ---
        const SUPABASE_URL = 'https://fzfnjtlzovbpbglvkroh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6Zm5qdGx6b3ZicGJnbHZrcm9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4OTcyMjEsImV4cCI6MjA3MTQ3MzIyMX0.yg43GbdVBPAzaghmERNGxRu9dte3bcpWTWjrOa0p55I';
        const IMAGE_BUCKET_NAME = 'thought-images';
        
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const state = { 
            user: null, 
            quill: null,
            isAuthReady: false
        };
        const $ = (selector) => document.querySelector(selector);

        // --- ANIMATIONS & UI ---
        const animations = {
            pageEnter: (el) => anime({ targets: el, translateY: [20, 0], opacity: [0, 1], duration: 500, easing: 'easeOutCubic' }),
            pageExit: (el) => anime({ targets: el, translateY: [0, -20], opacity: [1, 0], duration: 300, easing: 'easeInCubic' }).finished,
            modalEnter: (backdrop, content) => {
                anime({ targets: backdrop, opacity: [0, 1], duration: 400, easing: 'easeOutCubic' });
                anime({ targets: content, translateY: [20, 0], scale: [0.98, 1], opacity: [0, 1], duration: 400, easing: 'easeOutCubic' });
            },
            modalExit: (backdrop, content) => {
                anime({ targets: backdrop, opacity: [1, 0], duration: 300, easing: 'easeInCubic' });
                return anime({ targets: content, translateY: [0, 20], scale: [1, 0.98], opacity: [1, 0], duration: 300, easing: 'easeInCubic' }).finished;
            },
            toastEnter: (el) => anime({ targets: el, translateX: [20, 0], opacity: [0, 1], duration: 400, easing: 'easeOutCubic' }),
            toastExit: (el) => anime({ targets: el, translateX: [0, 20], opacity: [1, 0], duration: 400, easing: 'easeInCubic' }).finished,
        };
        
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `py-2 px-4 rounded-md shadow-lg text-sm font-medium border ${isError ? 'bg-red-900/50 border-red-700 text-red-200' : 'bg-green-900/50 border-green-700 text-green-200'}`;
            toast.textContent = message;
            $('#toast-container').appendChild(toast);
            animations.toastEnter(toast);
            setTimeout(async () => {
                await animations.toastExit(toast);
                toast.remove();
            }, 3000);
        }

        function renderModal({ title, content, confirmText, onConfirm, confirmAction }) {
            const modalId = `modal-${Date.now()}`;
            const modalHtml = `
                <div id="${modalId}" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-backdrop absolute inset-0 bg-black/80 backdrop-blur-sm" data-action="close-modal"></div>
                    <div class="modal-content relative bg-content border border-border-color rounded-lg shadow-xl w-full max-w-sm p-6">
                        <h3 class="text-lg font-bold font-heading mb-4">${title}</h3>
                        <div class="text-gray-400 mb-6 text-sm">${content}</div>
                        <div class="flex justify-end space-x-2">
                            <button type="button" class="btn" data-action="close-modal">취소</button>
                            ${confirmText ? `<button type="button" class="btn btn-primary" data-action="${confirmAction}" id="modal-confirm-btn">${confirmText}</button>` : ''}
                        </div>
                    </div>
                </div>`;
            $('#modal-container').innerHTML = modalHtml;
            const modalEl = $(`#${modalId}`);
            animations.modalEnter(modalEl.querySelector('.modal-backdrop'), modalEl.querySelector('.modal-content'));

            if (onConfirm) {
                 $('#modal-confirm-btn').addEventListener('click', onConfirm);
            }
        }
        
        async function closeModal() {
            const modal = $('#modal-container').firstElementChild;
            if (!modal) return;
            await animations.modalExit(modal.querySelector('.modal-backdrop'), modal.querySelector('.modal-content'));
            $('#modal-container').innerHTML = '';
        }

        // --- AUTHENTICATION ---
        function showAuthModal() {
            const content = `
                <form id="auth-form" novalidate class="space-y-4">
                    <div>
                        <label for="email" class="block text-xs font-medium text-gray-400 mb-1">이메일</label>
                        <input type="email" id="email" class="form-input" required autocomplete="email">
                    </div>
                    <div>
                        <label for="password" class="block text-xs font-medium text-gray-400 mb-1">비밀번호 (6자 이상)</label>
                        <input type="password" id="password" class="form-input" required autocomplete="current-password" minlength="6">
                    </div>
                    <div id="auth-error" class="text-red-400 text-xs h-3"></div>
                </form>`;
            renderModal({ 
                title: '시작하기', 
                content, 
                confirmText: '로그인',
                confirmAction: 'login'
            });
            const modalContent = $('.modal-content');
            const signUpBtn = document.createElement('button');
            signUpBtn.type = 'button';
            signUpBtn.className = 'btn';
            signUpBtn.dataset.action = 'signup';
            signUpBtn.textContent = '회원가입';
            $('#modal-confirm-btn').insertAdjacentElement('beforebegin', signUpBtn);
        }
        
        function translateAuthError(error) {
            const message = error.message;
            if (message.includes("Invalid login credentials")) return "이메일 또는 비밀번호가 올바르지 않습니다.";
            if (message.includes("User already registered")) return "이미 가입된 이메일입니다. 로그인을 시도해주세요.";
            if (message.includes("Password should be at least 6 characters")) return "비밀번호는 6자 이상이어야 합니다.";
            if (message.includes("Unable to validate email address")) return "유효하지 않은 이메일 형식입니다.";
            return "오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
        }

        async function handleAuth(action) {
            const email = $('#email').value;
            const password = $('#password').value;
            const errorDiv = $('#auth-error');
            errorDiv.textContent = '';

            let result;
            if (action === 'login') {
                result = await supabase.auth.signInWithPassword({ email, password });
            } else { // signup
                result = await supabase.auth.signUp({ email, password });
            }

            const { error } = result;
            if (error) {
                errorDiv.textContent = translateAuthError(error);
            } else {
                if (action === 'signup') {
                    showToast('가입이 완료되었습니다! 이메일을 확인하여 인증해주세요.');
                } else {
                    showToast('로그인되었습니다.');
                }
                closeModal();
            }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                showToast('로그아웃 중 오류가 발생했습니다.', true);
            } else {
                showToast('로그아웃되었습니다.');
                window.location.hash = '/';
            }
        }
        
        // --- CORE LOGIC & ROUTING ---
        async function switchView(viewId, callback) {
            const currentView = $('.app-view.active');
            if (currentView) {
                await animations.pageExit(currentView);
                currentView.classList.remove('active');
                currentView.innerHTML = '';
            }

            const nextView = $(`#${viewId}`);
            if (nextView) {
                if (callback) await callback(nextView);
                nextView.classList.add('active');
                animations.pageEnter(nextView);
            }
        }
        
        function handleRouting() {
            if (!state.isAuthReady) return;

            const hash = window.location.hash || '#/';
            const [path, id] = hash.substring(2).split('/');
            
            // Simplified: if a user is not logged in, they can't access dashboard or writer
            if (!state.user && (path === 'dashboard' || path === 'writer')) {
                showToast('글을 작성하려면 로그인이 필요합니다.', true);
                window.location.hash = '/';
                return;
            }

            switch (path) {
                case 'post': switchView('view-post', (el) => renderPostView(el, id)); break;
                case 'dashboard': switchView('view-dashboard', renderDashboardView); break;
                case 'writer': switchView('view-writer', (el) => renderWriterView(el, id)); break;
                default: switchView('view-library', renderLibraryView);
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderNav() {
            const navContainer = $('#main-nav-container');
            navContainer.innerHTML = `
                <nav class="w-full max-w-5xl flex items-center justify-between py-2 px-4 bg-black/30 backdrop-blur-lg border border-border-color rounded-lg">
                    <a href="#/" class="brand-logo" data-action="route">CortexLog</a>
                    <div class="flex items-center space-x-2">
                        ${state.user 
                            ? `<a href="#/dashboard" class="btn" data-action="route">대시보드</a><button data-action="logout" class="btn">로그아웃</button>`
                            : `<button data-action="show-auth" class="btn btn-primary">로그인 / 가입</button>`
                        }
                    </div>
                </nav>`;
        }
        
        async function renderLibraryView(container) {
            const { data, error } = await supabase.from('posts').select('*').order('created_at', { ascending: false });
            if (error) {
                showToast('데이터를 불러오는 데 실패했습니다.', true);
                container.innerHTML = `<p class="text-center text-gray-400 py-20">글을 불러올 수 없습니다.</p>`;
                return;
            }

            const postsHtml = data.length > 0 ? data.map(post => `
                <a href="#/post/${post.id}" data-action="route" class="block p-6 bg-content border border-transparent hover:border-border-color rounded-lg transition-all duration-300 group">
                    <h2 class="text-xl font-bold font-heading mb-2 text-gray-200 group-hover:text-white transition-colors">${post.title}</h2>
                    <p class="text-gray-400 mb-3 text-sm">${post.summary || ''}</p>
                    <p class="text-xs text-gray-500">${new Date(post.created_at).toLocaleDateString('ko-KR')}</p>
                </a>
            `).join('') : `<p class="text-center text-gray-400 py-20">아직 작성된 글이 없습니다.</p>`;

            container.innerHTML = `
                <div class="py-16">
                    <h1 class="text-4xl font-extrabold text-center font-heading mb-4">Thoughts & Insights</h1>
                    <p class="text-center text-gray-400 mb-12">AI, 기술, 그리고 일상에 대한 기록들</p>
                    <div class="space-y-4">${postsHtml}</div>
                </div>
            `;
        }

        async function renderPostView(container, id) {
            if (!id) { window.location.hash = '/'; return; }
            const { data: post, error } = await supabase.from('posts').select('*').eq('id', id).single();
            if (error || !post) {
                showToast('글을 찾을 수 없습니다.', true);
                window.location.hash = '/';
                return;
            }

            container.innerHTML = `
                <article class="prose-custom max-w-none py-12">
                    <h1 class="text-3xl font-extrabold !mt-0">${post.title}</h1>
                    <p class="text-sm text-gray-500 mb-8">${new Date(post.created_at).toLocaleString('ko-KR')}</p>
                    <div>${post.refined_content || ''}</div>
                </article>
            `;
        }
        
        async function renderDashboardView(container) {
            // Show only posts created by the current user
            const { data: posts, error } = await supabase.from('posts').select('*')
                .eq('author_id', state.user.id)
                .order('created_at', { ascending: false });
             if (error) {
                showToast('내 글 목록 로딩 실패: ' + error.message, true);
                container.innerHTML = `<p>내가 작성한 글을 불러올 수 없습니다.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="py-12">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-2xl font-bold font-heading">내 글 관리</h1>
                        <a href="#/writer" class="btn btn-primary" data-action="route">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                            새 글 작성하기
                        </a>
                    </div>
                    <div class="bg-content border border-border-color rounded-lg">
                        <ul class="divide-y divide-border-color">
                            ${posts.length > 0 ? posts.map(post => `
                                <li class="p-4 flex justify-between items-center">
                                    <div>
                                        <a href="#/post/${post.id}" data-action="route" class="font-bold hover:text-white">${post.title}</a>
                                        <p class="text-xs text-gray-500 mt-1">${new Date(post.created_at).toLocaleString('ko-KR')}</p>
                                    </div>
                                    <div class="space-x-2">
                                        <a href="#/writer/${post.id}" class="btn text-xs" data-action="route">수정</a>
                                        <button class="btn text-xs" data-action="delete-post" data-id="${post.id}">삭제</button>
                                    </div>
                                </li>
                            `).join('') : '<li class="p-4 text-center text-gray-500">작성된 글이 없습니다.</li>'}
                        </ul>
                    </div>
                </div>
            `;
        }

        async function renderWriterView(container, id) {
            let post = { title: '', summary: '', refined_content: '' };
            if (id) {
                const { data, error } = await supabase.from('posts').select('*').eq('id', id).single();
                if (error) { showToast('글 정보를 가져오지 못했습니다.', true); window.location.hash = '#/dashboard'; return; }
                
                // Security check: ensure the user is editing their own post
                if (data.author_id !== state.user.id) {
                    showToast('자신이 작성한 글만 수정할 수 있습니다.', true);
                    window.location.hash = '#/dashboard';
                    return;
                }
                post = data;
            }

            container.innerHTML = `
                <div class="py-12">
                    <h1 class="text-2xl font-bold font-heading mb-8">${id ? '글 수정하기' : '새 글 작성하기'}</h1>
                    <form id="writer-form" class="space-y-6">
                        <input type="hidden" id="post-id" value="${id || ''}">
                        <div>
                            <label for="title" class="block text-sm font-medium text-gray-300 mb-2">제목</label>
                            <input type="text" id="title" class="form-input" required value="${post.title}">
                        </div>
                        <div>
                            <label for="summary" class="block text-sm font-medium text-gray-300 mb-2">요약 (메인 페이지에 표시됩니다)</label>
                            <textarea id="summary" class="form-textarea" rows="3" required>${post.summary}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">본문</label>
                            <div id="editor"></div>
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" id="submit-btn" class="btn btn-primary">저장하기</button>
                        </div>
                    </form>
                </div>
            `;
            initQuillEditor(post.refined_content || '');
        }

        // --- Quill Editor & Image Handling ---
        function initQuillEditor(initialContent) {
            if (state.quill) state.quill = null;
            state.quill = new Quill('#editor', {
                theme: 'snow',
                modules: { toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike', 'blockquote', 'code-block'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image'], ['clean']
                ] }
            });
            state.quill.root.innerHTML = initialContent;
            state.quill.getModule('toolbar').addHandler('image', selectLocalImage);
        }

        function selectLocalImage() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.click();
            input.onchange = async () => {
                const file = input.files[0];
                if (file) await uploadImageAndInsert(file);
            };
        }

        async function uploadImageAndInsert(file) {
            if (!state.user) {
                showToast('이미지 업로드는 로그인이 필요합니다.', true); return;
            }
            if (file.size > 2 * 1024 * 1024) { // 2MB limit
                showToast('이미지 파일은 2MB를 초과할 수 없습니다.', true); return;
            }
            const fileName = `${state.user.id}/${Date.now()}-${file.name}`;
            showToast('이미지를 업로드하는 중입니다...');
            const { error } = await supabase.storage.from(IMAGE_BUCKET_NAME).upload(fileName, file);
            if (error) {
                showToast(`업로드 실패: ${error.message}`, true); return;
            }
            const { data } = supabase.storage.from(IMAGE_BUCKET_NAME).getPublicUrl(fileName);
            if (data) {
                const range = state.quill.getSelection(true);
                state.quill.insertEmbed(range.index, 'image', data.publicUrl);
                showToast('이미지가 성공적으로 업로드되었습니다.');
            }
        }

        // --- Event Handlers ---
        async function handleGlobalClick(target) {
            const action = target.dataset.action;
            const id = target.dataset.id;

            switch (action) {
                case 'route': window.location.hash = target.hash; break;
                case 'show-auth': showAuthModal(); break;
                case 'close-modal': closeModal(); break;
                case 'login': handleAuth('login'); break;
                case 'signup': handleAuth('signup'); break;
                case 'logout': handleLogout(); break;
                case 'delete-post':
                    renderModal({
                        title: '정말 삭제하시겠습니까?',
                        content: '이 작업은 되돌릴 수 없습니다.',
                        confirmText: '삭제',
                        confirmAction: 'confirm-delete',
                        onConfirm: async () => {
                            const { error } = await supabase.from('posts').delete().eq('id', id);
                            if (error) {
                                showToast('삭제 실패: ' + error.message, true);
                            } else {
                                showToast('글이 삭제되었습니다.');
                                handleRouting(); // Refresh the view
                            }
                            closeModal();
                        }
                    });
                    break;
            }
        }
        
        async function handleWriterSubmit() {
            const id = $('#post-id').value;
            const title = $('#title').value;
            const summary = $('#summary').value;
            const refined_content = state.quill.root.innerHTML;

            if (!title.trim() || !summary.trim()) {
                showToast('제목과 요약은 필수 항목입니다.', true); return;
            }
            $('#submit-btn').disabled = true;
            
            const postData = { 
                title, 
                summary, 
                refined_content,
                author_id: state.user.id // **IMPORTANT: Set the author on creation**
            };
            
            const result = id 
                ? await supabase.from('posts').update({ title, summary, refined_content }).eq('id', id)
                : await supabase.from('posts').insert(postData);

            $('#submit-btn').disabled = false;
            if (result.error) {
                showToast(`저장 실패: ${result.error.message}`, true);
            } else {
                showToast(id ? '글이 수정되었습니다!' : '글이 생성되었습니다!');
                window.location.hash = '#/dashboard';
            }
        }

        // --- INITIALIZATION ---
        function initializeApp() {
            window.addEventListener('hashchange', handleRouting);
            document.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (target) { e.preventDefault(); handleGlobalClick(target); }
            });
            document.addEventListener('submit', (e) => {
                if (e.target.id === 'writer-form') { e.preventDefault(); handleWriterSubmit(); }
                if (e.target.id === 'auth-form') e.preventDefault();
            });

            supabase.auth.onAuthStateChange(async (_event, session) => {
                state.user = session?.user || null;
                
                renderNav();

                if (!state.isAuthReady) {
                    state.isAuthReady = true;
                    const loader = $('#app-loader');
                    anime({ targets: loader, opacity: 0, duration: 500, easing: 'easeOutCubic', complete: () => loader.style.display = 'none' });
                    handleRouting(); 
                } else {
                    handleRouting();
                }
            });
        }
        
        // --- Dynamic Background (Self-invoking) ---
        (function setupDynamicBackground() {
            const canvas = $('#app-background');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let particles = [];
            const particleCount = Math.min(40, window.innerWidth / 30);

            const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
            window.addEventListener('resize', resize, { passive: true });
            resize();

            class Particle {
                constructor() { this.reset(); this.radius = Math.random() * 1.2 + 0.3; }
                reset() {
                    this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                    this.vx = (Math.random() - 0.5) * 0.15; this.vy = (Math.random() - 0.5) * 0.15;
                }
                update() {
                    this.x += this.vx; this.y += this.vy;
                    if (this.x < 0 || this.x > canvas.width) this.vx *= -1;
                    if (this.y < 0 || this.y > canvas.height) this.vy *= -1;
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                    ctx.fill();
                }
            }
            for (let i = 0; i < particleCount; i++) particles.push(new Particle());
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => { p.update(); p.draw(); });
                requestAnimationFrame(animate);
            }
            animate();
        })();

        initializeApp();
    </script>
</body>
</html>


